<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šäº¤æ›æŠ½ç±¤å·¥å…·</title>
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åŸºç¤æ¨£å¼è¨­å®š */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }

        /* ç¶²æ ¼ä½ˆå±€è¨­ç½®ï¼šç¢ºä¿å¡ç‰‡åœ¨ç¶²æ ¼ä¸­å±…ä¸­ä¸¦ç¶­æŒ 5 æ¬„ */
        .class-grid-responsive {
            /* é è¨­: è‡ªå‹•é©æ‡‰ï¼Œä¿æŒéŸ¿æ‡‰æ€§ */
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            justify-items: center; /* ç¶²æ ¼é …ç›®å±…ä¸­ */
            gap: 1rem; /* å¢åŠ é–“è·ï¼Œé˜²æ­¢å¡ç‰‡ç·Šè²¼ */
        }
        @media (min-width: 640px) {
            /* æ¡Œé¢ç‰ˆä¿®æ­£: é‡æ–°ä½¿ç”¨å½ˆæ€§å¯¬åº¦ (1fr)ï¼Œè§£æ±ºæº¢å‡ºå•é¡Œï¼Œä¸¦ç¢ºä¿ç½®ä¸­ */
            .class-grid-responsive {
                grid-template-columns: repeat(5, 1fr); /* ä½¿ç”¨ 1fr ç¢ºä¿å½ˆæ€§é©æ‡‰å¯¬åº¦ */
                justify-content: center; /* ç½®ä¸­ç¶²æ ¼å…§çš„å…§å®¹ */
            }
        }
        /* ç§»é™¤ä¹‹å‰å˜—è©¦ç½®ä¸­æ™‚æ·»åŠ çš„å›ºå®šå¯¬åº¦å’Œ margin: autoï¼Œè®“ Flexbox é‡æ–°è² è²¬å‡åˆ† */


        /* å®šç¾©å¡ç‰‡é¡è‰²çµ„ */
        .color-set-1 { background-color: #e0f2fe; border-color: #90cdf4; color: #2b6cb0; } /* è—è‰² */
        .color-set-2 { background-color: #fefcbf; border-color: #faf089; color: #b7791f; } /* é»ƒè‰² */
        .color-set-3 { background-color: #fed7d7; border-color: #feb2b2; color: #c53030; } /* ç´…è‰² */
        .color-set-4 { background-color: #e9d8fd; border-color: #d6bcfa; color: #6b46c1; } /* ç´«è‰² */
        .color-set-default { background-color: #edf2f7; border-color: #cbd5e0; color: #4a5568; } /* ç°è‰² */

        /* ä¸€èˆ¬å¡ç‰‡æ¨£å¼ (é•·æ–¹å½¢ï¼Œé¡ä¼¼æ’²å…‹ç‰Œæ¯”ä¾‹) */
        .class-card {
            /* ä¿®æ­£: ç§»é™¤å›ºå®šå¯¬åº¦ï¼Œæ”¹ç”¨ max-width å’Œ max-heightï¼Œè®“å…¶åœ¨ç©ºé–“ä¸è¶³æ™‚èƒ½ç¸®å° */
            width: 100%; /* ä½”æ»¿ç¶²æ ¼å–®å…ƒå¯¬åº¦ */
            max-width: 120px; /* æœ€å¤§å¯¬åº¦ä¸è¶…éæ’²å…‹ç‰Œå°ºå¯¸ */
            height: 180px; /* å›ºå®šé«˜åº¦ï¼Œä½†æœƒåœ¨ç©ºé–“ä¸è¶³æ™‚è¢«æ“ å£“ */
            
            border-radius: 0.5rem;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.1);
            transition: transform 0.2s;
            justify-self: center; /* è®“å¡ç‰‡åœ¨ç¶²æ ¼å–®å…ƒä¸­ç½®ä¸­ */
            padding: 0.5rem;
            border: 2px solid;
            font-weight: bold;
            display: flex;
            flex-direction: column; 
            justify-content: center;
            align-items: center;
            text-align: center; /* ç¢ºä¿æ–‡å­—æ’ç‰ˆä¸­å¿ƒå°é½Š */
        }
        .class-card:hover {
            transform: scale(1.05);
        }

        /* æ–‡å­—æ’ç‰ˆæ¨£å¼ (ç¢ºä¿æ–‡å­—æ¸…æ™°ä¸”å‚ç›´å †ç–Š) */
        .class-text-sm { font-size: 0.8em; }
        .class-text-lg { font-size: 1.8em; font-weight: 800; }

        /* é‡å°å°è¢å¹•èª¿æ•´å°ºå¯¸ */
        @media (max-width: 639px) {
            .class-card {
                max-width: 100px; 
                height: 150px;
            }
            .class-text-sm { font-size: 0.7em; }
            .class-text-lg { font-size: 1.5em; }
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div id="app" class="w-full max-w-6xl bg-white p-6 sm:p-10 rounded-xl shadow-2xl border border-gray-100">

        <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-6 text-indigo-700">
            ç­ç´šäº¤æ›æŠ½ç±¤å·¥å…·
        </h1>
        <p class="text-center text-gray-500 mb-8">
            è«‹è¨­å®šå¹´ç´šå’Œç­ç´šæ•¸é‡ï¼Œæ’åˆ—æœƒå‹•æ…‹æ›´æ–°ï¼Œç„¶å¾Œé»æ“ŠæŒ‰éˆ•é€²è¡ŒæŠ½ç±¤äº¤æ›ã€‚
        </p>

        <!-- è¨­å®šå€å¡Š --><div class="flex flex-col md:flex-row gap-4 mb-8 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
            
            <!-- å¹´ç´šé¸æ“‡ --><div class="flex-1">
                <label for="gradeSelect" class="block text-sm font-medium text-indigo-700 mb-1">é¸æ“‡å¹´ç´š (ä¸ƒ, å…«, ä¹):</label>
                <select id="gradeSelect" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    <option value="ä¸ƒ">ä¸ƒå¹´ç´š</option>
                    <option value="å…«">å…«å¹´ç´š</option>
                    <option value="ä¹">ä¹å¹´ç´š</option>
                </select>
            </div>

            <!-- ç­ç´šæ•¸è¼¸å…¥ --><div class="flex-1">
                <label for="numClassesInput" class="block text-sm font-medium text-indigo-700 mb-1">ç­ç´šç¸½æ•¸ (1 - 20):</label>
                <input type="number" id="numClassesInput" min="1" max="20" value="20" 
                       class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                       placeholder="è¼¸å…¥ç­ç´šæ•¸">
            </div>
        </div>

        <!-- ç­ç´šé¡¯ç¤ºå€å¡Š --><div id="classDisplays" class="flex flex-col lg:flex-row gap-8 mb-8">
            
            <!-- åŸå§‹ç­ç´šæ’åˆ— (å·¦å´) -->
            <div id="originalClassesSection" class="flex-1 p-4 border border-gray-200 rounded-lg bg-gray-50 hidden">
                <h2 id="originalTitle" class="text-xl font-bold text-gray-700 mb-4 text-center">åŸå§‹ç­ç´šæ’åˆ—</h2>
                <div id="originalClassGridContainer" class="class-grid-responsive grid gap-4 transition-opacity duration-300">
                    <!-- åŸå§‹ç­ç´šå¡ç‰‡å°‡æœƒè¢« JavaScript æ’å…¥åˆ°é€™è£¡ --></div>
            </div>

            <!-- ç›®å‰çš„ç­ç´šæ’åˆ— (å³å´) -->
            <div id="shuffledClassesSection" class="flex-1 p-4 border border-indigo-200 rounded-lg bg-indigo-50">
                <h2 id="currentTitle" class="text-xl font-bold text-indigo-700 mb-4 text-center">ç›®å‰çš„ç­ç´šæ’åˆ—</h2>
                <div id="currentClassGridContainer" class="class-grid-responsive grid gap-4 transition-opacity duration-300">
                    <!-- ç­ç´šå¡ç‰‡å°‡æœƒè¢« JavaScript æ’å…¥åˆ°é€™è£¡ --></div>
            </div>
        </div>


        <!-- äº¤æ›æŒ‰éˆ• --><div class="text-center">
            <button id="swapButton" disabled
                    class="px-10 py-4 text-xl font-bold text-white bg-green-600 rounded-xl shadow-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105 transition duration-200 ease-in-out focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50">
                ğŸš€ éš¨æ©Ÿäº¤æ›ç­ç´š ğŸš€
            </button>
        </div>

        <!-- è¨Šæ¯é¡¯ç¤ºå€ --><p id="message" class="mt-6 text-center text-red-500 font-medium"></p>
    </div>

    <script>
        // --- è®Šæ•¸åˆå§‹åŒ– ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // DOM å…ƒç´ åƒè€ƒ
        const gradeSelect = document.getElementById('gradeSelect');
        const numClassesInput = document.getElementById('numClassesInput');
        const swapButton = document.getElementById('swapButton');
        const originalClassesSection = document.getElementById('originalClassesSection');
        const originalClassGridContainer = document.getElementById('originalClassGridContainer');
        const currentClassGridContainer = document.getElementById('currentClassGridContainer');
        const messageDisplay = document.getElementById('message');
        const originalTitle = document.getElementById('originalTitle');
        const currentTitle = document.getElementById('currentTitle');

        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
        let originalClasses = []; 
        let currentClasses = [];  
        let currentGrade = 'ä¸ƒ';
        let currentNumClasses = 20; // é è¨­å€¼æ”¹ç‚º 20

        // ç­ç´šå¡ç‰‡çš„é¡è‰²çµ„
        const classCardColors = ['color-set-1', 'color-set-2', 'color-set-3', 'color-set-4'];

        // --- è¼”åŠ©å‡½å¼ ---

        /** é¡¯ç¤ºéŒ¯èª¤æˆ–æˆåŠŸè¨Šæ¯ã€‚ */
        function showMessage(text, type = 'error') {
            messageDisplay.textContent = text;
            messageDisplay.className = `mt-6 text-center font-medium ${type === 'error' ? 'text-red-500' : 'text-blue-600'}`;
            setTimeout(() => {
                messageDisplay.textContent = '';
            }, 3000); 
        }

        /** æª¢æŸ¥å…©å€‹é™£åˆ—æ˜¯å¦ç‚ºéŒ¯æ’ (Derangement)ã€‚ */
        function isDerangement(arr1, arr2) {
            if (arr1.length !== arr2.length) return false;
            for (let i = 0; i < arr1.length; i++) {
                if (arr1[i] === arr2[i]) {
                    return false;
                }
            }
            return true;
        }

        /** åŸ·è¡Œ Fisher-Yates ç®—æ³•æ‰“äº‚é™£åˆ—ã€‚ */
        function fisherYatesShuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }
        }

        // --- æ ¸å¿ƒé‚è¼¯å‡½å¼ ---

        /** æ ¹æ“šå…§å®¹å’Œæ¨£å¼å‰µå»ºå–®ä¸€å¡ç‰‡çš„ DOM å…ƒç´ ã€‚ */
        function createCardElement(content, colorClass) { 
            const card = document.createElement('div');
            card.className = `class-card ${colorClass}`;

            // å¡ç‰‡åç¨±æ’ç‰ˆ
            const gradeMatch = content.match(/(\S+å¹´)(\d+)(ç­)/);
            if (gradeMatch) {
                
                const gradeText = document.createElement('span');
                gradeText.className = 'class-text-sm whitespace-nowrap';
                gradeText.textContent = gradeMatch[1]; 
                card.appendChild(gradeText);
                
                const classNumberText = document.createElement('span');
                classNumberText.className = 'class-text-lg whitespace-nowrap text-3xl font-extrabold';
                classNumberText.textContent = gradeMatch[2]; 
                card.appendChild(classNumberText);

                const classSuffixText = document.createElement('span');
                classSuffixText.className = 'class-text-sm whitespace-nowrap';
                classSuffixText.textContent = gradeMatch[3]; 
                card.appendChild(classSuffixText);

            } else {
                card.textContent = content;
            }
            
            return card;
        }

        /** æ¸²æŸ“ç­ç´šæ’åˆ—åˆ°æŒ‡å®šçš„å®¹å™¨ä¸­ï¼Œä½¿ç”¨åˆ—å„ªå…ˆé †åºæ’åˆ— (å›ºå®š 5 è¡Œ)ã€‚ */
        function renderClasses(container, classes) {
            container.innerHTML = ''; 

            const N = classes.length;
            if (N === 0) return;
            
            const C_MAX = 5; // æœ€å¤§æ¬„æ•¸
            const R_MAX = 5; // å›ºå®šè¡Œæ•¸
            
            const C_NEEDED = Math.ceil(N / R_MAX); 
            const TOTAL_GRID_CELLS = R_MAX * C_MAX;
            
            // è½‰ç½®é‚è¼¯ï¼šå°‡ Row-first é™£åˆ—è½‰æ›ç‚º Column-first è¦–è¦ºé †åº
            const transposedClasses = [];
            for (let k = 0; k < TOTAL_GRID_CELLS; k++) {
                const r = Math.floor(k / C_MAX); 
                const c = k % C_MAX; 
                const i = r + c * R_MAX; // Column-first ç´¢å¼•è¨ˆç®—

                if (c < C_NEEDED && i < N) {
                   transposedClasses.push(classes[i]);
                } else {
                   transposedClasses.push(null); 
                }
            }
            
            // ä½¿ç”¨ transposedClasses é™£åˆ—é€²è¡Œæ¸²æŸ“
            transposedClasses.forEach((content, index) => {
                if (content === null) {
                    const emptyCard = document.createElement('div');
                    emptyCard.className = "class-card opacity-0 pointer-events-none"; 
                    container.appendChild(emptyCard);
                    return; 
                }
                
                const colorClass = classCardColors[index % classCardColors.length] || 'color-set-default';
                const cardElement = createCardElement(content, colorClass);
                container.appendChild(cardElement);
            });
        }
        
        /** åˆå§‹åŒ–ç­ç´šé™£åˆ—åŠæ¸²æŸ“ã€‚ */
        function initializeClasses() {
            let selectedGrade = gradeSelect.value;
            let num = parseInt(numClassesInput.value, 10);

            if (isNaN(num) || num < 1 || num > 20) {
                showMessage('ç­ç´šç¸½æ•¸å¿…é ˆåœ¨ 1 åˆ° 20 ä¹‹é–“ã€‚', 'error');
                numClassesInput.value = currentNumClasses;
                return;
            }

            const numChanged = currentNumClasses !== num;
            const gradeChanged = currentGrade !== selectedGrade;
            
            currentNumClasses = num;
            currentGrade = selectedGrade;
            
            // --- ç‹€æ…‹æ›´æ–°/é™£åˆ—é‡å»ºé‚è¼¯ ---
            if (numChanged || gradeChanged || originalClasses.length === 0) {
                
                if (numChanged || originalClasses.length === 0) {
                    originalClasses = []; 
                    for (let i = 1; i <= currentNumClasses; i++) {
                        originalClasses.push(`${currentGrade}å¹´${i}ç­`);
                    }
                    currentClasses = [...originalClasses]; // åˆå§‹æ™‚ currentClasses ç­‰æ–¼ originalClasses
                } else if (gradeChanged) {
                    // æ›´æ–°å¹´ç´šåç¨±
                    originalClasses = originalClasses.map((_, i) => `${currentGrade}å¹´${i + 1}ç­`);
                    
                    const originalMap = originalClasses.reduce((acc, name) => {
                        const match = name.match(/(\d+)/);
                        if (match) acc[match[1]] = name;
                        return acc;
                    }, {});
                    
                    currentClasses = currentClasses.map(oldName => {
                        const classNumberMatch = oldName.match(/(\d+)/);
                        const classNumber = classNumberMatch ? classNumberMatch[1] : null;
                        return originalMap[classNumber] || `${currentGrade}å¹´${classNumber}ç­`;
                    }).filter(name => name.endsWith('ç­'));
                }
            }
            
            swapButton.disabled = false;
            
            // åˆå§‹ç‹€æ…‹: å·¦å´éš±è—ï¼Œå³å´é¡¯ç¤ºåŸå§‹ç­ç´šé †åº
            originalClassesSection.classList.add('hidden');
            renderClasses(currentClassGridContainer, originalClasses); 

            // å¦‚æœå·¦å³é™£åˆ—ä¸åŒ (æ›¾ç¶“äº¤æ›é)ï¼Œå‰‡é¡¯ç¤ºå·¦å´
            const isShuffled = originalClasses.some((name, i) => name !== currentClasses[i]);
            if (isShuffled) {
                originalClassesSection.classList.remove('hidden');
                renderClasses(originalClassGridContainer, originalClasses);
                renderClasses(currentClassGridContainer, currentClasses);
            }
        }

        /** éš¨æ©Ÿäº¤æ›ç­ç´š (ä¿è­‰éŒ¯æ’ï¼Œç¬é–“æ›´æ–°)ã€‚ */
        function shuffleClasses() {
            swapButton.disabled = true;
            swapButton.textContent = 'ğŸ² æŠ½ç±¤ä¸­...';
            showMessage('æ­£åœ¨é€²è¡Œéš¨æ©ŸæŠ½ç±¤ï¼Œè«‹ç¨å€™...', 'success'); 
            
            
            // --- åŸ·è¡ŒéŒ¯æ’æ‰“äº‚ ---
            let attempts = 0;
            let newShuffledArray;
            do {
                newShuffledArray = [...originalClasses]; 
                fisherYatesShuffle(newShuffledArray);
                attempts++;
            } while (!isDerangement(originalClasses, newShuffledArray) && attempts < 50);
            currentClasses = newShuffledArray; // å°‡æ–°çµæœè³¦å€¼çµ¦ currentClasses
            // --- éŒ¯æ’æ‰“äº‚çµæŸ ---

            // 1. é¡¯ç¤ºåŸå§‹ç­ç´šæ’åˆ—
            originalClassesSection.classList.remove('hidden');
            renderClasses(originalClassGridContainer, originalClasses); 
            
            // 2. é‡æ–°æ¸²æŸ“ç›®å‰çš„ç­ç´šæ’åˆ— (ç¬é–“æ›´æ–°)
            renderClasses(currentClassGridContainer, currentClasses); 
            
            // 3. è¨­ç½®ä¸€å€‹å»¶é²ï¼Œä»¥æ¨¡æ“¬æŠ½ç±¤éç¨‹
            setTimeout(() => {
                // é‡ç½®æŒ‰éˆ•å’Œè¨Šæ¯
                swapButton.textContent = 'ğŸš€ éš¨æ©Ÿäº¤æ›ç­ç´š ğŸš€';
                swapButton.disabled = false;
                showMessage('ç­ç´šäº¤æ›æŠ½ç±¤å®Œæˆï¼', 'success');
            }, 600); // å»¶é² 0.6 ç§’ï¼Œæ¨¡æ“¬è™•ç†æ™‚é–“
        }

        /** è™•ç†æŒ‰éˆ•é»æ“Šäº‹ä»¶å’Œåˆå§‹åŒ–è¨­å®šã€‚ */
        function setupEventListeners() {
            numClassesInput.addEventListener('input', initializeClasses);
            gradeSelect.addEventListener('change', initializeClasses);
            swapButton.addEventListener('click', shuffleClasses);
            initializeClasses();
        }

        // ç¨‹å¼å•Ÿå‹•
        window.onload = function() {
            setupEventListeners();
        };

    </script>

</body>
</html>
